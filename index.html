<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">
    <link rel="shortcut icon" href="ico/favicon.png">

    <title>Mapa</title>

    <script src="http://code.jquery.com/jquery-1.10.2.min.js"></script>

    <link href="vendor/bootswatch/bootstrap.min.css" rel="stylesheet">
    <link href="css/sticky-footer.css" rel="stylesheet">
    <link href="vendor/font-awesome/css/font-awesome.min.css" rel="stylesheet">
    
    <script src="vendor/bootstrap/js/bootstrap.min.js"></script>

    <script src="vendor/momentjs/moment-with-langs.min.js"></script>
    
    <script src="http://d3js.org/d3.v3.js"></script>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/lodash.js/1.0.0-rc.3/lodash.underscore.min.js"></script>


    <script src="http://libs.cartocdn.com/cartodb.js/v3/cartodb.js"></script>
    <link rel="stylesheet" href="http://libs.cartocdn.com/cartodb.js/v3/themes/css/cartodb.css" />
    <!--[if lte IE 8]>
    <link rel="stylesheet" href="http://libs.cartocdn.com/cartodb.js/v3/themes/css/cartodb.ie.css" />
    <![endif]-->

    <style type="text/css">

      body {
        background: #ddd url(images/grid.png);
        height: 100%;
      }

      html {
        height: 100%;
      }

      .main-padder {
        padding: 30px;
        background: white;
      }

      .container.with-navbar {
        padding-top: 45px;
      }

      #footer {
        background: #444 url(images/noisy_net.png);
      }

      .mapa-y-filtros {
        position: relative;
      }

      .mapa-y-filtros h5:first-child {
        margin-top: 0px;
        margin-bottom: 9px;
      }

      .titulo-color {
        color: #09A1ED;
        font-weight: 400;
      }

      @media (min-width: 768px) {
        .navbar-nav.navbar-right:last-child { /* Overriding default bootstrap style */
          margin-right: 0px;
        }
      }

      @media (max-width: 479px) {
        .main-padder {
          padding: 10px;
          background: white;
        }
      }

      #map { 
        height: 500px;
        width: 100%;
      }

      #sidebar { 
        height: 500px;
        width: 300px;
        color: #333;
        position: absolute;
        top: 20px;
        right: 20px;
        background: white;
        display: none;
        z-index: 1000;
        box-shadow: 0px 0px 15px #999;
        border-bottom: 8px solid #09A1ED;
      }

      #sidebar #cerrar-sidebar { 
        height: 24px;
        width: 24px;
        opacity: .5;
        position: absolute;
        top: 10px;
        right: 10px;
        cursor: pointer;
      }

      #sidebar-padder {
        padding: 20px;
      }

      svg {
        font: 10px sans-serif;
      }

      .axis path, .axis line {
        fill: none;
        stroke: #ccc;
        shape-rendering: crispEdges;
      }

      #splatter { display: none }

      .circle {
        visibility: hidden; 
        opacity: 0.7;
        stroke: #0077ee;
        stroke-width: 2;
        cursor: pointer;
        fill: #0077dd;
      }
      .circle.selected { visibility: visible; }

      .filtros div { margin-bottom: 5px; }

      .filtros button {
        display: block;
        width: 100%;
        background: white;
        border: 1px solid #ddd;
        font-size: 9pt;
      }

      .filtros h5:first-child {
        margin-top: 0px;
      }

      .filtros button:hover {
        color: #333;
      }

      .filtros button.active {
        background: rgb(41, 82, 122);
        color: white;
      }

      .leaflet-zoom-hide circle {
        visibility: hidden;
      }

      .leaflet-zoom-hide circle.selected {
        visibility: visible;
      }

      /* Estilos para D3 */ 
      .axis path,
      .axis line {
        fill: none;
        stroke: #777;
        shape-rendering: crispEdges;
      }

      .resize rect {
        visibility: visible !important;
        fill: #777 !important;
        stroke: #444 !important;
        opacity: .7 !important;
      }


    </style>
    
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->
  </head>

  <body>

    <div id="wrap">

      <div class="navbar navbar-default navbar-fixed-top" role="navigation">
        <div class="container">
          <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
              <span class="sr-only">Secciones</span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="#">Homicidios 2013</a>
          </div>
          <div class="collapse navbar-collapse">
            <ul class="nav navbar-nav">
              <li class="active"><a href="#">Inicio</a></li>
              <li><a href="#about">Acerca de</a></li>
            </ul>
          </div><!--/.nav-collapse -->
        </div>
      </div>

      <div class="container with-navbar">

        <div class="main-padder">

          <div class="row">
            <div class="col-md-2">
              <div class="filtros">
                <h5 class="titulo-color">Filtros <small>- Click para activar</small></h5>
                <h6>Distritos</h6>
                <div id="distritos-togglers">
                  <div><button data-id="7" type="button" class="boton-filtro">Distrito Sur</button></div>
                  <div><button data-id="4" type="button" class="boton-filtro">Distrito Norte</button></div>
                  <div><button data-id="6" type="button" class="boton-filtro">Distrito Oeste</button></div>
                  <div><button data-id="3" type="button" class="boton-filtro">Distrito Centro</button></div>
                  <div><button data-id="5" type="button" class="boton-filtro">Distrito Noroeste</button></div>
                  <div><button data-id="8" type="button" class="boton-filtro">Distrito Sudoeste</button></div>
                </div>
                <h6>Comisarías</h6>
                <div id="comisarias-togglers">
                  <div><button data-id="28" type="button" class="boton-filtro">Comisaría 1</button></div>
                  <div><button data-id="20" type="button" class="boton-filtro">Comisaría 2</button></div>
                  <div><button data-id="13" type="button" class="boton-filtro">Sub Comisaría 2</button></div>
                  <div><button data-id="31" type="button" class="boton-filtro">Comisaría 3</button></div>
                  <div><button data-id="29" type="button" class="boton-filtro">Comisaría 4</button></div>
                  <div><button data-id="15" type="button" class="boton-filtro">Comisaría 5</button></div>
                  <div><button data-id="8" type="button" class="boton-filtro">Comisaría 6</button></div>
                  <div><button data-id="30" type="button" class="boton-filtro">Comisaría 7</button></div>
                  <div><button data-id="10" type="button" class="boton-filtro">Comisaría 8</button></div>
                  <div><button data-id="23" type="button" class="boton-filtro">Comisaría 10</button></div>
                  <div><button data-id="14" type="button" class="boton-filtro">Comisaría 11</button></div>
                  <div><button data-id="6" type="button" class="boton-filtro">Comisaría 12</button></div>
                  <div><button data-id="3" type="button" class="boton-filtro">Comisaría 13</button></div>
                  <div><button data-id="5" type="button" class="boton-filtro">Comisaría 14</button></div>
                  <div><button data-id="16" type="button" class="boton-filtro">Comisaría 15</button></div>
                  <div><button data-id="21" type="button" class="boton-filtro">Comisaría 16</button></div>
                  <div><button data-id="24" type="button" class="boton-filtro">Comisaría 17</button></div>
                  <div><button data-id="7" type="button" class="boton-filtro">Comisaría 18</button></div>
                  <div><button data-id="4" type="button" class="boton-filtro">Comisaría 19</button></div>
                  <div><button data-id="11" type="button" class="boton-filtro">Sub Comisaría 19</button></div>
                  <div><button data-id="18" type="button" class="boton-filtro">Comisaría 20</button></div>
                  <div><button data-id="22" type="button" class="boton-filtro">Sub Comisaría 20</button></div>
                  <div><button data-id="12" type="button" class="boton-filtro">Comisaría 21</button></div>
                  <div><button data-id="17" type="button" class="boton-filtro">Sub Comisaría 21</button></div>
                  <div><button data-id="25" type="button" class="boton-filtro">Sub Comisaría 22</button></div>
                  <div><button data-id="19" type="button" class="boton-filtro">Sub Comisaría 24</button></div>
                  <div><button data-id="26" type="button" class="boton-filtro">Comisaría 30</button></div>
                  <div><button data-id="27" type="button" class="boton-filtro">Comisaría 32</button></div>
                  <div><button data-id="9" type="button" class="boton-filtro">Comisaría 33</button></div>
                </div>
              </div>
            </div>
            <div class="col-md-10 mapa-y-filtros">

              <h5 class="titulo-color">Mapa <small>- Hacé click en los puntos para más detalles.</small></h5>

              <div>
                <h4><span id="filtros-fechadesde">16 de Junio</span> <small>al</small> <span id="filtros-fechahasta">23 de Noviembre</span> <small>-</small> <span id="cantidad-puntos"></span> <small>homicidios</small> <small>-</small> 55% <small>del total</small></h4>
                <h5 id="textoFiltros"></h5>
              </div>
              <div id='map' data-source="mapa.json"></div>
             
              <h5 class="titulo-color">Línea de Tiempo <small>- Seleccioná un área en la línea del tiempo para filtrar por fecha.</small></h5>
              
              <div id="timeline"></div>

              <div id="sidebar">
                <img src="images/close.png" id="cerrar-sidebar">
                <div id="sidebar-padder"></div>
              </div>

            </div>
          </div>

          <script type="text/html" id="sideTemplate">
              <h4><img src="images/cruz.png" style="height: 16px"> <%- victimas %></h4>
              <h5><img src="images/fecha.png" style="height: 16px"> <%- fecha %></h5>
              <h5><img src="images/map-pin.png" style="height: 16px"> <%- direccion %></h5>
              <h5><img src="images/comisaria.png" style="height: 16px"> <%- comisaria %></h5>
              <p><%- resumen %></p>
          </script>
          
          <script type="text/javascript">


            moment.lang("es");
            var mapaHomicidios = {};

            mapaHomicidios.brush = null;
            mapaHomicidios.cantidadPuntos = 0;

            mapaHomicidios.actualizarTextoFiltros = function() {
              var seleccionadas = [];
              $("#comisarias-togglers button").each(function() {
                if ($(this).hasClass("active")) {
                  seleccionadas.push($(this).html());
                }
              });
              var spanComisarias = $("<span/>");
              spanComisarias.attr("id", "filtro-comisarias")
              if (seleccionadas.length > 0) {
                spanComisarias.html(seleccionadas.join(", "));
              }
              $("#filtro-comisarias").remove(); 
              $("#textoFiltros").append(spanComisarias);
              $("#cantidad-puntos").html(mapaHomicidios.cantidadPuntos);
            };

            mapaHomicidios.obtenerFechaPunto = function(d) {
              return d3.time.format("%d/%m/%y").parse(d.properties.fecha);
            }

            mapaHomicidios.mostrarPuntosFiltrados = function() {
              var comisariasSeleccionadas = obtenerComisariasSeleccionadas();
              var rangoFechas = mapaHomicidios.brush.extent();

              var selection = d3.selectAll(".leaflet-overlay-pane path").classed("selected", function (d) {

                  var fechaPunto = mapaHomicidios.obtenerFechaPunto(d);
                  var enFecha = rangoFechas[0] <= fechaPunto && fechaPunto <= rangoFechas[1];
                  var enComisaria = false;

                  var nro = d.properties.comisaria.replace("ª", "");
                  if (comisariasSeleccionadas.length > 0) {
                    var indiceEnArray = comisariasSeleccionadas.indexOf(nro);
                    if (indiceEnArray > -1) {
                      enComisaria = true;
                    }
                  } else {
                    enComisaria = true;
                  }

                  return enFecha && enComisaria;
              });

              mapaHomicidios.cantidadPuntos = selection.filter(".selected")[0].length;

            }


            nro_comisaria = {
              "28": "1",
              "20": "2",
              "13": "sub2",
              "31": "3",
              "29": "4",
              "15": "5",
              "8": "6",
              "30": "7",
              "10": "8",
              "23": "10",
              "14": "11",
              "6": "12",
              "3": "13",
              "5": "14",
              "16": "15",
              "21": "16",
              "24": "17",
              "7": "18",
              "4": "19",
              "11": "sub19",
              "18": "20",
              "22": "sub20",
              "12": "21",
              "17": "sub21",
              "25": "sub22",
              "19": "sub24",
              "26": "30",
              "27": "32",
              "9": "33"
            }

            function obtenerComisariasSeleccionadas() {
              var seleccionadas = [];
              $("#comisarias-togglers button").each(function() {
                if ($(this).hasClass("active")) {
                  seleccionadas.push(nro_comisaria[$(this).data("id")]);
                }
              });
              return seleccionadas;
            }

            function main() {

                var extent, scale, 
                    classes = 9,
                    reverse = false;
                    container = L.DomUtil.get('map');

                var tpl = document.getElementById("sideTemplate").text;

                var map = new L.Map('map', {
                  zoomControl: false,
                  center: [-32.9598, -60.6423],
                  zoom: 13
                });

                L.tileLayer('http://{s}.tiles.mapbox.com/v3/hhrosario.map-wygexzoy/{z}/{x}/{y}.png', {
                  attribution: 'OpenStreetMaps',
                  maxZoom: 17
                }).addTo(map);

                cartodb.createLayer(map, 'http://hhrosario.cartodb.com/api/v2/viz/d058deb0-6dcc-11e3-bc71-b7b26ac0527a/viz.json', function(layer) {

                   layer.show();
                   var layerDistritos = layer.createSubLayer({
                     sql: 'SELECT * FROM distritos',
                     cartocss: "#distritos { polygon-fill: orange; polygon-opacity: 0.2; line-width: 2; line-color: #a82; line-opacity: 1; }",
                     interactivity: "cartodb_id, name"
                   });
                   layerDistritos.hide();

                   layerDistritos.setInteraction(true);
                   layerDistritos.on('featureClick', function(e, latlng, pos, data, subLayerIndex) {
                    $("#sidebar-padder").html(data.name);
                   });

                   $("#distritos-togglers button").on("click", function() {

                     var seleccionados = [];
                     if($(this).hasClass("active")) {
                      $(this).removeClass("active");
                      } else {
                      $(this).addClass("active");
                     }

                     $("#distritos-togglers button").each(function() {
                      if ($(this).hasClass("active")) {
                        seleccionados.push($(this).data("id"));
                      }
                     });

                     if (seleccionados.length > 0) {
                        layerDistritos.setSQL("SELECT * FROM distritos WHERE cartodb_id IN (" + seleccionados.join(", ") + ")");
                        layerDistritos.show();
                     } else {
                        layerDistritos.hide();
                     }

                   });

                   //layer.show();
                   var layerComisarias = layer.createSubLayer({
                     sql: 'SELECT * FROM comisarias',
                     cartocss: '#comisarias { polygon-fill: #75B7F0; polygon-opacity: 0.4; line-width: 1; line-color: #06569C; line-opacity: .8; }'
                   });
                   //var sublayer = layer.getSubLayer(1);
                   layerComisarias.hide();

                   $("#comisarias-togglers button").on("click", function() {

                     var seleccionados = [];
                     if($(this).hasClass("active")) {
                      $(this).removeClass("active");
                      } else {
                      $(this).addClass("active");
                     }

                     $("#comisarias-togglers button").each(function() {
                      if ($(this).hasClass("active")) {
                        seleccionados.push($(this).data("id"));
                      }
                     });
                     
                     
                     if (seleccionados.length > 0) {
                        layerComisarias.setSQL("SELECT * FROM comisarias WHERE cartodb_id IN (" + seleccionados.join(", ") + ")");
                        layerComisarias.show();
                     } else {
                        layerComisarias.hide();
                     }

                    /*
                    var selection = d3.selectAll("path").classed("selected", function (d) {
                      var seleccionadas = obtenerComisariasSeleccionadas();
                      if (d.properties) {
                        var nro = d.properties.comisaria.replace("ª", "");
                        var indiceEnArray = seleccionadas.indexOf(nro);
                        if (indiceEnArray > -1) {
                          return true;
                        }
                      }
                    });

                    
                    */

                    mapaHomicidios.mostrarPuntosFiltrados();
                    mapaHomicidios.actualizarTextoFiltros();

                   });

                }).addTo(map);

                // Agregar la capa SVG para los puntos a Leaflet
                var svg = d3.select(map.getPanes().overlayPane).append("svg"),
                    g = svg.append("g").attr("class", "leaflet-zoom-hide");

                d3.json("homicidios.json", function(collection) {

                  // Dibuja los puntos sobre el mapa de Leaflet con D3.js
                  var transform = d3.geo.transform({point: projectPoint}),
                      path = d3.geo.path().projection(transform),
                      bounds = path.bounds(collection);

                  // Obtener los puntos y asignar una clase
                  var feature = g.selectAll(".leaflet-overlay-pane path")
                    .data(collection.features)
                    .enter()
                    .append("path")
                    .attr("class", "circle");
                  
                  // Listener para el click en un punto del mapa
                  feature.on("click", function (d, i) {
                    L.DomEvent.stopPropagation(d3.event);
                    var data = {
                        fecha: d.properties.fecha,
                        direccion: d.properties.direccion,
                        victimas: d.properties.victimas,
                        resumen: d.properties.resumen,
                        comisaria: d.properties.comisaria
                    };
                    document.getElementById('sidebar-padder').innerHTML = _.template(tpl, data);
                    $("#sidebar").fadeIn();
                  });

                  map.on("viewreset", resetSVG);

                  resetSVG();

                  function resetSVG() {
                    // Reposicionar la capa SVG que se añade al mapa 
                    var topLeft = bounds[0],
                        bottomRight = bounds[1];

                    svg.attr("width", bottomRight[0] - topLeft[0])
                       .attr("height", bottomRight[1] - topLeft[1])
                       .style("left", topLeft[0] + "px")
                       .style("top", topLeft[1] + "px");

                    g.attr("transform", "translate(" + -topLeft[0] + "," + -topLeft[1] + ")");

                    feature.attr("d", path);

                  }

                  // Use Leaflet to implement a D3 geometric transformation.
                  function projectPoint(x, y) {
                    var point = map.latLngToLayerPoint(new L.LatLng(y, x));
                    this.stream.point(point.x, point.y);
                  }

                  var chart = timeseries_chart()
                    .x(mapaHomicidios.obtenerFechaPunto).xLabel("Fecha")
                    .y(get_quantity).yLabel("Casos")
                    .brushmove(on_brush);
                  d3.select("#timeline").datum(collection.features).call(chart);

////////////

                function on_brush(brush) {
                  if (brush) {
                    mapaHomicidios.brush = brush;
                  }
                  var s = brush.extent();
                  $("#filtros-fechadesde").html(moment(s[0]).format("D [de] MMMM"));
                  $("#filtros-fechahasta").html(moment(s[1]).format("D [de] MMMM"));
                  
                  mapaHomicidios.mostrarPuntosFiltrados();
                  mapaHomicidios.actualizarTextoFiltros();

                  /*d3.selectAll(".leaflet-overlay-pane path").classed("selected", function (d) {
                      var time = get_time(d);
                      return s[0] <= time && time <= s[1];
                  });*/
                }

                function get_quantity(d) {
                  return 69; // Porno numérico arbitrario, en realidad acá podriamos contar la cantidad de casos en una fecha
                }

              function timeseries_chart() {
                  var margin = { top: 20, right: 20, bottom: 20, left: 20 },
                      width = 860,
                      height = 80;

                  var x = d3.time.scale(),
                      y = d3.scale.linear(),
                      x_label = "X", y_label = "Y";
                  mapaHomicidios.brush = d3.svg.brush().x(x).on("brush", _brushmove);

                  var get_x = no_op,
                      get_y = no_op;

                  function translateMonth() {

                  }

                  function timeseries(selection) {
                      selection.each(function (d) {
                          x.range([0, width]);
                          y.range([height, 0]);

                          var series = d3.select(this).append("svg").attr("id", "mapa-timeseries")
                                  .attr("width", width + margin.left + margin.right)
                                  .attr("height", height + margin.top + margin.bottom)
                                  .append("g").attr("id", "date-brush")
                                  .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

                          var x_axis = series.append("g")
                            .attr("class", "x axis")
                            .attr("transform", "translate(0," + height + ")")
                            .style("stroke", "#444");

                          var y_axis = series.append("g")
                            .attr("class", "y axis");

                          x_axis.append("text")
                            .attr("class", "label")
                            .attr("x", width)
                            .attr("y", 30)
                            .style("text-anchor", "end")
                            .style("stroke", "blue")
                            .text(x_label);

                          y_axis.append("text")
                            .attr("class", "label")
                            .attr("transform", "rotate(-90)")
                            .attr("y", -40)
                            .attr("dy", ".71em")
                            .style("text-anchor", "end")
                            .style("stroke", "red")
                            .text(y_label);

                          series.append("clipPath")
                            .attr("id", "clip")
                            .append("rect")
                            .attr("width", width - 1)
                            .attr("height", height - .25)
                            .attr("transform", "translate(1,0)");

                          series.append("g")
                            .attr("class", "brush")
                            .call(mapaHomicidios.brush)
                            .selectAll("rect")
                            .attr("height", height)
                            .style("stroke-width", 1) // Borde groso para draggear
                            .style("stroke", '#0022aa')
                            .style("fill", '#0077dd')
                            .attr("opacity", 0.3);

                          x.domain(d3.extent(d, get_x));
                          x_axis.call(d3.svg.axis().tickFormat(function(d) {
                            return moment(d).format("MMM"); 
                          }).scale(x).orient("bottom"));

                          y.domain(d3.extent(d, get_y));
                          y_axis.call(d3.svg.axis().scale(y).orient("left"));

                          series.append("g").attr("class", "timeseries")
                              .attr("clip-path", "url(#clip)")
                              .selectAll("rect")
                              .data(d).enter()
                              .append("rect") // Deberían ser barras, más altas si hay más de un caso en ese día... veremos.
                              .style("stroke", '#0022aa')
                              .style("stroke-width", .5)
                              .style("fill", '#0077dd')
                              .attr("opacity", .8)
                              .attr("width", 3)
                              .attr("height", 30)
                              .attr("transform", function (d) {
                                  return "translate(" + x(get_x(d)) + "," + (y(get_y(d)) - 30) + ")";
                              });
                      });
                  }

                  timeseries.x = function (accessor) {
                      if (!arguments.length) return get_x;
                      get_x = accessor;
                      return timeseries;
                  };

                  timeseries.y = function (accessor) {
                      if (!arguments.length) return get_y;
                      get_y = accessor;
                      return timeseries;
                  };

                  timeseries.xLabel = function (label) {
                      if (!arguments.length) return x_label;
                      x_label = label;
                      return timeseries;
                  }

                  timeseries.yLabel = function (label) {
                      if (!arguments.length) return y_label;
                      y_label = label;
                      return timeseries;
                  }

                  timeseries.brushmove = function (cb) {
                      if (!arguments.length) return brushmove;
                      brushmove = cb;
                      return timeseries;
                  };

                  function _brushmove() {
                      brushmove.call(null, mapaHomicidios.brush);
                  }

                  function no_op() {}

                  return timeseries;

              }

/////////////
                }); // D3.json fin

              $("#cerrar-sidebar").on("click", function () {
                $("#sidebar").fadeOut();
              });

            };
            window.onload = main;
          </script>


        </div> <!-- main-padder -->
      </div> <!-- container -->
    </div> <!-- wrap -->

    <div id="footer">
      <div class="container">
        <p class="text-muted"><a target="_blank" href="http://www.hackshackers.com" class="btn-link footer-link">Hacks/Hackers Rosario</a></p>
      </div>
    </div>

  </body>
</html>
